{"ast":null,"code":"var Promise = require('bluebird');\n\nvar Decrypt = require('../Decrypt');\n\nvar PullStream = require('../PullStream');\n\nvar Stream = require('stream');\n\nvar binary = require('binary');\n\nvar zlib = require('zlib');\n\nvar parseExtraField = require('../parseExtraField');\n\nvar Buffer = require('../Buffer'); // Backwards compatibility for node versions < 8\n\n\nif (!Stream.Writable || !Stream.Writable.prototype.destroy) Stream = require('readable-stream');\n\nmodule.exports = function unzip(source, offset, _password) {\n  var file = PullStream(),\n      entry = Stream.PassThrough(),\n      vars;\n  var req = source.stream(offset);\n  req.pipe(file).on('error', function (e) {\n    entry.emit('error', e);\n  });\n  entry.vars = file.pull(30).then(function (data) {\n    var vars = binary.parse(data).word32lu('signature').word16lu('versionsNeededToExtract').word16lu('flags').word16lu('compressionMethod').word16lu('lastModifiedTime').word16lu('lastModifiedDate').word32lu('crc32').word32lu('compressedSize').word32lu('uncompressedSize').word16lu('fileNameLength').word16lu('extraFieldLength').vars;\n    return file.pull(vars.fileNameLength).then(function (fileName) {\n      vars.fileName = fileName.toString('utf8');\n      return file.pull(vars.extraFieldLength);\n    }).then(function (extraField) {\n      var checkEncryption;\n      vars.extra = parseExtraField(extraField, vars);\n      if (vars.flags & 0x01) checkEncryption = file.pull(12).then(function (header) {\n        if (!_password) throw new Error('MISSING_PASSWORD');\n        var decrypt = Decrypt();\n        String(_password).split('').forEach(function (d) {\n          decrypt.update(d);\n        });\n\n        for (var i = 0; i < header.length; i++) header[i] = decrypt.decryptByte(header[i]);\n\n        vars.decrypt = decrypt;\n        vars.compressedSize -= 12;\n        var check = vars.flags & 0x8 ? vars.lastModifiedTime >> 8 & 0xff : vars.crc32 >> 24 & 0xff;\n        if (header[11] !== check) throw new Error('BAD_PASSWORD');\n        return vars;\n      });\n      return Promise.resolve(checkEncryption).then(function () {\n        entry.emit('vars', vars);\n        return vars;\n      });\n    });\n  });\n  entry.vars.then(function (vars) {\n    var fileSizeKnown = !(vars.flags & 0x08),\n        eof;\n    var inflater = vars.compressionMethod ? zlib.createInflateRaw() : Stream.PassThrough();\n\n    if (fileSizeKnown) {\n      entry.size = vars.uncompressedSize;\n      eof = vars.compressedSize;\n    } else {\n      eof = Buffer.alloc(4);\n      eof.writeUInt32LE(0x08074b50, 0);\n    }\n\n    var stream = file.stream(eof);\n    if (vars.decrypt) stream = stream.pipe(vars.decrypt.stream());\n    stream.pipe(inflater).on('error', function (err) {\n      entry.emit('error', err);\n    }).pipe(entry).on('finish', function () {\n      if (req.abort) req.abort();else if (req.close) req.close();else if (req.push) req.push();else console.log('warning - unable to close stream');\n    });\n  }).catch(function (e) {\n    entry.emit('error', e);\n  });\n  return entry;\n};","map":{"version":3,"sources":["C:/TechQuartier/TechTalents/visibleImpact/visibleimpactapp/node_modules/unzipper/lib/Open/unzip.js"],"names":["Promise","require","Decrypt","PullStream","Stream","binary","zlib","parseExtraField","Buffer","Writable","prototype","destroy","module","exports","unzip","source","offset","_password","file","entry","PassThrough","vars","req","stream","pipe","on","e","emit","pull","then","data","parse","word32lu","word16lu","fileNameLength","fileName","toString","extraFieldLength","extraField","checkEncryption","extra","flags","header","Error","decrypt","String","split","forEach","d","update","i","length","decryptByte","compressedSize","check","lastModifiedTime","crc32","resolve","fileSizeKnown","eof","inflater","compressionMethod","createInflateRaw","size","uncompressedSize","alloc","writeUInt32LE","err","abort","close","push","console","log","catch"],"mappings":"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","sourcesContent":["var Promise = require('bluebird');\nvar Decrypt = require('../Decrypt');\nvar PullStream = require('../PullStream');\nvar Stream = require('stream');\nvar binary = require('binary');\nvar zlib = require('zlib');\nvar parseExtraField = require('../parseExtraField');\nvar Buffer = require('../Buffer');\n\n// Backwards compatibility for node versions < 8\nif (!Stream.Writable || !Stream.Writable.prototype.destroy)\n  Stream = require('readable-stream');\n\nmodule.exports = function unzip(source,offset,_password) {\n  var file = PullStream(),\n      entry = Stream.PassThrough(),\n      vars;\n\n  var req = source.stream(offset);\n  req.pipe(file).on('error', function(e) {\n    entry.emit('error', e);\n  });\n\n  entry.vars = file.pull(30)\n    .then(function(data) {\n      var vars = binary.parse(data)\n        .word32lu('signature')\n        .word16lu('versionsNeededToExtract')\n        .word16lu('flags')\n        .word16lu('compressionMethod')\n        .word16lu('lastModifiedTime')\n        .word16lu('lastModifiedDate')\n        .word32lu('crc32')\n        .word32lu('compressedSize')\n        .word32lu('uncompressedSize')\n        .word16lu('fileNameLength')\n        .word16lu('extraFieldLength')\n        .vars;\n      return file.pull(vars.fileNameLength)\n        .then(function(fileName) {\n          vars.fileName = fileName.toString('utf8');\n          return file.pull(vars.extraFieldLength);\n        })\n        .then(function(extraField) {\n          var checkEncryption;\n          vars.extra = parseExtraField(extraField, vars);\n          if (vars.flags & 0x01) checkEncryption = file.pull(12)\n            .then(function(header) {\n              if (!_password)\n                throw new Error('MISSING_PASSWORD');\n\n              var decrypt = Decrypt();\n\n              String(_password).split('').forEach(function(d) {\n                decrypt.update(d);\n              });\n\n              for (var i=0; i < header.length; i++)\n                header[i] = decrypt.decryptByte(header[i]);\n\n              vars.decrypt = decrypt;\n              vars.compressedSize -= 12;\n\n              var check = (vars.flags & 0x8) ? (vars.lastModifiedTime >> 8) & 0xff : (vars.crc32 >> 24) & 0xff;\n              if (header[11] !== check)\n                throw new Error('BAD_PASSWORD');\n\n              return vars;\n            });\n\n          return Promise.resolve(checkEncryption)\n            .then(function() {\n              entry.emit('vars',vars);\n              return vars;\n            });\n        });\n    });\n\n    entry.vars.then(function(vars) {\n      var fileSizeKnown = !(vars.flags & 0x08),\n          eof;\n\n      var inflater = vars.compressionMethod ? zlib.createInflateRaw() : Stream.PassThrough();\n\n      if (fileSizeKnown) {\n        entry.size = vars.uncompressedSize;\n        eof = vars.compressedSize;\n      } else {\n        eof = Buffer.alloc(4);\n        eof.writeUInt32LE(0x08074b50, 0);\n      }\n\n      var stream = file.stream(eof);\n\n      if (vars.decrypt)\n        stream = stream.pipe(vars.decrypt.stream());\n\n      stream\n        .pipe(inflater)\n        .on('error',function(err) { entry.emit('error',err);})\n        .pipe(entry)\n        .on('finish', function() {\n          if (req.abort)\n            req.abort();\n          else if (req.close)\n            req.close();\n          else if (req.push)\n            req.push();\n          else\n            console.log('warning - unable to close stream');\n        });\n    })\n    .catch(function(e) {\n      entry.emit('error',e);\n    });\n\n  return entry;\n};\n"]},"metadata":{},"sourceType":"script"}